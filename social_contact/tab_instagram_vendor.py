'''
## ëª©ë¡ ì‹œíŠ¸
https://docs.google.com/spreadsheets/d/1PZD3IgbJJwOtJGKwW8jO-YD24z6eEPrtbxQxERRIog4/edit?gid=1655394428#gid=1655394428

## í…œí”Œë¦¿ ì‹œíŠ¸
https://docs.google.com/spreadsheets/d/1mwZ37jiEGK7rQnLWp87yUQZHyM6LHb4q6mbB0A07fI0/edit?gid=1655394428#gid=1655394428


## ğŸš©ìš”ì•½
ì…€ëŸ¬ë³„ íƒ€ê²ŒíŒ…í•´ì„œ dmë³´ë‚´ëŠ” ë°±ì—”ë“œì…ë‹ˆë‹¤.
ë©”ì„¸ì§€ ë³´ë‚´ëŠ” ë¶€ë¶„ì€ ëª¨ë“ˆë¡œ ì„í¬íŠ¸ ë˜ì–´ìˆìŠµë‹ˆë‹¤. (instagram_message_vendor.py)

## í…œí”Œë¦¿ ì‹œíŠ¸ ë³€ìˆ˜
í…œí”Œë¦¿ì—ì„œ {ì´ë¦„}, {ë…¸ì…˜ë¦¬ìŠ¤íŠ¸}ë¥¼ ë³€ìˆ˜ë¡œ ë°›ì•„ì„œ ë©”ì„¸ì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.


## ğŸš©ì‚¬ìš©ë²•
- ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ í”„ë¡œí•„ ì„ íƒí•©ë‹ˆë‹¤. (*ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œí•„ ëª©ë¡:)
- DMë³´ë‚¼ ì¸ì› ëª©ë¡ ì‹œíŠ¸ë¥¼ ì„ íƒí•©ë‹ˆë‹¤. (*1. ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸ ëª©ë¡:) 
    - ë°œì†¡ì¡°ê±´ - Gì—´ì— ë¦¬ìŠ¤íŠ¸ìƒì„±ì¼ì´ ìˆìœ¼ë‚˜, Hì—´ DMë°œì†¡ ì‹œíŠ¸ê°€ ë¹ˆ ê°’ì¸ ê²½ìš° ë°œì†¡ì†¡ì¡°ê±´ì— í•´ë‹¹
    
    - ### ğŸš©ì¶”í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •ì‚¬í•­ : ë¦¬ìŠ¤íŠ¸ìƒì„±ì¼ì„ ë³´ê³  ë°œì†¡ì¡°ê±´ ìˆ˜ì •
    - ğŸš©(ì˜µì…˜1. ì˜¤ëŠ˜ë‚ ì§œ / ì˜µì…˜2. ìµœê·¼ nì¼ / **ğŸš©ì˜µì…˜3. ë¦¬ìŠ¤íŠ¸ìƒì„±ì¼ê³¼ DMë°œì†¡ì‹œê°„ ì°¨ì´ê°€ nì¼ ì´ìƒì¸ ê²½ìš°** / ì˜µì…˜4. íŠ¹ì • ë‚ ì§œ ì´í›„ / ì˜µì…˜5. ì˜µì…˜ë³„ ë²ˆí˜¸ ì„ íƒ)
    - ğŸš©ì´ 200ëª…ì˜ ì¸ì›ì´ ìˆìŠµë‹ˆë‹¤. 10ì¼ ê¸°ì¤€ìœ¼ë¡œ ì¸ì›”ë“¤ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•  ê²ƒì…ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ í•˜ë£¨ì— 20ëª… ì”© ë°œì†¡í•  ê²ƒì…ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ 10ì¼ ì†Œìš”ë©ë‹ˆë‹¤.

- í…œí”Œë¦¿ ì‹œíŠ¸ë¥¼ ì„ íƒí•©ë‹ˆë‹¤. (*2. ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸ ëª©ë¡:)
- ìµœì¢… ë°œì†¡í•  ì¸í”Œë£¨ì–¸ì„œ í™•ì¸ í›„ Yë¥¼ ëˆŒëŸ¬ ë°œì†¡í•©ë‹ˆë‹¤.

- ë°œì†¡ ì™„ë£Œ í›„ ëª©ë¡ ì‹œíŠ¸ì—ì„œ ë°œì†¡ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ëª½ê³ dbì—ë„ ë¡œê·¸ê¸°ë¡ë¡)


'''
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
import random
import time
import os
import shutil
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException
import pyperclip
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.action_chains import ActionChains
from auth import get_credentials
from googleapiclient.discovery import build
import logging
from datetime import datetime
from dotenv import load_dotenv
import sys
from pymongo import MongoClient
from pymongo.server_api import ServerApi
from instagram_message_vendor import InstagramMessageTemplate
from pathlib import Path

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID ì„¤ì •
DM_LIST_SPREADSHEET_ID = '1PZD3IgbJJwOtJGKwW8jO-YD24z6eEPrtbxQxERRIog4'
TEMPLATE_SPREADSHEET_ID = '1mwZ37jiEGK7rQnLWp87yUQZHyM6LHb4q6mbB0A07fI0'

# MongoDB ì—°ê²° ì„¤ì •
uri = "mongodb+srv://coq3820:JmbIOcaEOrvkpQo1@cluster0.qj1ty.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0"
try:
    mongo_client = MongoClient(uri, 
                             server_api=ServerApi('1'),
                             tlsAllowInvalidCertificates=True)
    mongo_client.admin.command('ping')
    print("MongoDB ì—°ê²° ì„±ê³µ!")
    
    db = mongo_client['insta09_database']
    dm_collection = db['gogoya_DmRecords']
    mongo_connected = True
except Exception as e:
    print(f"MongoDB ì—°ê²° ì‹¤íŒ¨: {e}")
    mongo_connected = False

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ íŒŒì´ì¬ ê²½ë¡œì— ì¶”ê°€
project_root = Path(__file__).parent.parent.absolute()
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

from notion_module.notion_reader import get_database_items, extract_page_id_from_url, print_database_items

def clear_chrome_data(user_data_dir, keep_login=True):
    default_dir = os.path.join(user_data_dir, 'Default')
    if not os.path.exists(default_dir):
        print("Default ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    dirs_to_clear = ['Cache', 'Code Cache', 'GPUCache']
    files_to_clear = ['History', 'Visited Links', 'Web Data']
    
    for dir_name in dirs_to_clear:
        dir_path = os.path.join(default_dir, dir_name)
        if os.path.exists(dir_path):
            shutil.rmtree(dir_path)
            print(f"{dir_name} ë””ë ‰í† ë¦¬ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.")

    if not keep_login:
        files_to_clear.extend(['Cookies', 'Login Data'])

    for file_name in files_to_clear:
        file_path = os.path.join(default_dir, file_name)
        if os.path.exists(file_path):
            os.remove(file_path)
            print(f"{file_name} íŒŒì¼ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.")

def get_sheet_names(service, spreadsheet_id):
    """ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ëª¨ë“  ì‹œíŠ¸ ì´ë¦„ì„ ê°€ì ¸ì˜´"""
    try:
        sheet_metadata = service.spreadsheets().get(spreadsheetId=spreadsheet_id).execute()
        sheets = sheet_metadata.get('sheets', '')
        return [sheet.get("properties", {}).get("title", "") for sheet in sheets]
    except Exception as e:
        print(f"ì‹œíŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return []

def select_sheet(service, spreadsheet_id):
    """ì‚¬ìš©ìì—ê²Œ ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ë„ë¡ í•¨"""
    sheet_names = get_sheet_names(service, spreadsheet_id)
    if not sheet_names:
        print("ì‹œíŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None
        
    print("\nì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸ ëª©ë¡:")
    for idx, name in enumerate(sheet_names, 1):
        print(f"{idx}. {name}")
        
    while True:
        try:
            choice = int(input("\nì‚¬ìš©í•  ì‹œíŠ¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”: "))
            if 1 <= choice <= len(sheet_names):
                selected_sheet = sheet_names[choice - 1]
                print(f"\nì„ íƒëœ ì‹œíŠ¸: {selected_sheet}")
                return selected_sheet
            else:
                print("ìœ íš¨í•˜ì§€ ì•Šì€ ë²ˆí˜¸ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.")
        except ValueError:
            print("ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

def get_data_from_sheets(service, selected_sheet):
    logging.info("URLê³¼ ì´ë¦„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘")
    try:
        sheet = service.spreadsheets()
        # Aì—´(URL), Bì—´(ì´ë¦„), Eì—´(ë…¸ì…˜ë¦¬ìŠ¤íŠ¸), Gì—´, Hì—´, Kì—´ê¹Œì§€ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì •
        result = sheet.values().get(spreadsheetId=DM_LIST_SPREADSHEET_ID,
                                    range=f'{selected_sheet}!A2:K').execute()
        values = result.get('values', [])

        if not values:
            logging.warning('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
            return []

        # URL, ì´ë¦„, ë…¸ì…˜ë¦¬ìŠ¤íŠ¸, Gì—´ ê°’ ë°˜í™˜
        url_name_pairs = []
        for row in values:
            if (row and 
                (len(row) < 8 or not row[7]) and  # Hì—´ì´ ë¹„ì–´ìˆìŒ
                len(row) > 6 and row[6] and  # Gì—´ì— ê°’ì´ ìˆìŒ
                row[6].isdigit() and len(row[6]) == 6):  # Gì—´ì´ 6ìë¦¬ ìˆ«ìì¸ ê²½ìš°ë§Œ
                
                notion_url = row[4] if len(row) > 4 else ""  # Eì—´ì—ì„œ ë…¸ì…˜ URL
                total_list_url = row[10] if len(row) > 10 else ""  # Kì—´ì—ì„œ ì „ì²´ ë¦¬ìŠ¤íŠ¸ URL
                
                if notion_url:
                    try:
                        page_id = extract_page_id_from_url(notion_url)
                        items = get_database_items(page_id)
                        
                        if items:
                            product_list = []
                            for idx, item in enumerate(items, 1):
                                try:
                                    properties = item.get('properties', {})
                                    brand = ""
                                    item_name = ""
                                    
                                    for prop_name, prop_value in properties.items():
                                        try:
                                            if prop_value.get('type') == 'title':
                                                title_array = prop_value.get('title', [])
                                                if title_array and len(title_array) > 0:
                                                    brand = title_array[0].get('plain_text', '')
                                            elif prop_value.get('type') == 'rich_text':
                                                rich_text = prop_value.get('rich_text', [])
                                                if rich_text and len(rich_text) > 0:
                                                    text = rich_text[0].get('plain_text', '')
                                                    if prop_name == '2.ì•„ì´í…œ':
                                                        item_name = text
                                        except Exception as e:
                                            logging.error(f"ì†ì„± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                                            continue
                                    
                                    if brand and item_name:
                                        product_list.append(f"{idx}. {brand} - {item_name}")
                                except Exception as e:
                                    logging.error(f"ì•„ì´í…œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                                    continue
                            
                            notion_list = "\n".join(product_list) if product_list else ""
                        else:
                            notion_list = ""
                    except Exception as e:
                        logging.error(f"ë…¸ì…˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                        notion_list = ""
                else:
                    notion_list = ""
                
                url_name_pairs.append((
                    row[0],  # URL
                    row[1] if len(row) > 1 else "",  # ì´ë¦„
                    notion_list,  # ë…¸ì…˜ì—ì„œ ê°€ì ¸ì˜¨ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸
                    row[6] if len(row) > 6 else "",  # Gì—´ ê°’
                    total_list_url  # Kì—´ì—ì„œ ê°€ì ¸ì˜¨ ì „ì²´ ë¦¬ìŠ¤íŠ¸ URL
                ))
        
        return url_name_pairs

    except Exception as e:
        logging.error(f"ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return []

def update_sheet_status(service, row, status, timestamp=None, sheet_name=None):
    if not sheet_name:
        return
        
    sheet_id = DM_LIST_SPREADSHEET_ID
    # Hì—´ì— ìƒíƒœì™€ ì‹œê°„ì„ í•¨ê»˜ ê¸°ë¡
    range_name = f'{sheet_name}!H{row}'
    
    # ì„±ê³µ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„, ì‹¤íŒ¨ ì‹œ 'failed' ê¸°ë¡
    value = timestamp if status == 'Y' else 'failed'
    values = [[value]]
    body = {'values': values}
    
    service.spreadsheets().values().update(
        spreadsheetId=sheet_id,
        range=range_name,
        valueInputOption='USER_ENTERED',
        body=body
    ).execute()

def countdown(wait_time, message):
    print(f"{message}: {wait_time:.2f}ì´ˆ", end='\r')
    for remaining in range(int(wait_time), 0, -1):
        print(f"{message}: {remaining}ì´ˆ ë‚¨ìŒ    ", end='\r')
        time.sleep(1)
    print(f"{message} ì™„ë£Œ!    ", end='\r')

def process_url(driver, url, name, notion_list, g_value, total_list, template_manager, row, service, sheet_name, user_data_dir):
    driver.get(url)
    print(driver.title)
    wait_time = random.uniform(5, 10) #ì›ë˜ 300ì´ˆì˜€ìŒ
    countdown(wait_time, "URL ì ‘ì† í›„ ëŒ€ê¸°")

    try:
        # ë¨¼ì € íŒ”ë¡œìš° ë²„íŠ¼ í™•ì¸
        try:
            follow_button = WebDriverWait(driver, 5).until(
                EC.presence_of_element_located((By.XPATH, 
                    "//button[.//div[contains(text(), 'íŒ”ë¡œìš°') or contains(text(), 'íŒ”ë¡œì‰')]]"))
            )
            button_text = follow_button.find_element(By.XPATH, ".//div").text
            
            if button_text == "íŒ”ë¡œìš°":
                follow_button.click()
                print("íŒ”ë¡œìš° ì™„ë£Œ")
                wait_time = random.uniform(4, 12)
                countdown(wait_time, "íŒ”ë¡œìš° í›„ ëŒ€ê¸°")
        except TimeoutException:
            print("íŒ”ë¡œìš° ë²„íŠ¼ì´ ì—†ê±°ë‚˜ ì´ë¯¸ íŒ”ë¡œìš° ì¤‘ì…ë‹ˆë‹¤.")
            pass

        message_button = WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.XPATH, "//div[contains(@class, 'x1i10hfl') and contains(text(), 'ë©”ì‹œì§€ ë³´ë‚´ê¸°')]"))
        )
        print(f"ë²„íŠ¼ í…ìŠ¤íŠ¸: {message_button.text}")
        message_button.click()
        wait_time = random.uniform(5, 20) #ì›ë˜ 60ì´ˆì˜€ìŒ
        countdown(wait_time, "DM ë²„íŠ¼ í´ë¦­ í›„ ëŒ€ê¸°")

        message = template_manager.format_message(template_manager.get_message_templates()[0], name, notion_list, total_list)
        pyperclip.copy(message)
        
        actions = ActionChains(driver)
        WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.XPATH, "//div[contains(@role, 'textbox')]"))
        ).click()
        
        if sys.platform == 'darwin':
            actions.key_down(Keys.COMMAND).send_keys('v').key_up(Keys.COMMAND).perform()
        else:
            actions.key_down(Keys.CONTROL).send_keys('v').key_up(Keys.CONTROL).perform()
        
        wait_time = random.uniform(10, 20)
        countdown(wait_time, "ë©”ì‹œì§€ ì…ë ¥ í›„ ëŒ€ê¸°")

        actions.send_keys(Keys.ENTER).perform()

        # ì„±ê³µì ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆì„ ë•Œ
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        update_sheet_status(service, row, 'Y', timestamp, sheet_name)
        
        # MongoDBì— DM ê¸°ë¡ ì €ì¥
        save_dm_record_to_mongodb(
            influe_name=name,
            contact_profile=os.path.basename(user_data_dir),
            status='Y',
            dm_date=timestamp,
            content='ê³µêµ¬ë¬¸ì˜',
            message=message
        )

    except TimeoutException:
        print("'ë©”ì‹œì§€ ë³´ë‚´ê¸°' ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        update_sheet_status(service, row, 'failed', None, sheet_name)
        
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        save_dm_record_to_mongodb(
            influe_name=name,
            contact_profile=os.path.basename(user_data_dir),
            status='failed',
            dm_date=timestamp,
            content='ê³µêµ¬ë¬¸ì˜',
            message="ë©”ì‹œì§€ ë³´ë‚´ê¸° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
        )
    except NoSuchElementException:
        print("ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        update_sheet_status(service, row, 'failed', None, sheet_name)
        
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        save_dm_record_to_mongodb(
            influe_name=name,
            contact_profile=os.path.basename(user_data_dir),
            status='failed',
            dm_date=timestamp,
            content='ê³µêµ¬ë¬¸ì˜',
            message="ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
        )

def save_dm_record_to_mongodb(influe_name, contact_profile, status, dm_date, content, message):
    if not mongo_connected:
        print("MongoDBì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•Šì•„ ê¸°ë¡ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
        
    try:
        record = {
            "influencer_name": influe_name,
            "contact_profile": contact_profile,
            "status": status,
            "dm_date": dm_date,
            "template_content": content,
            "message": message,
            "created_at": datetime.now()
        }
        
        dm_collection.insert_one(record)
        print(f"MongoDBì— DM ê¸°ë¡ ì €ì¥ ì„±ê³µ: {influe_name}")
    except Exception as e:
        print(f"MongoDBì— DM ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: {e}")

def get_available_profiles(user_data_parent):
    """ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œí•„ ëª©ë¡ì„ ê°€ì ¸ì˜´"""
    profiles = []
    if not os.path.exists(user_data_parent):
        os.makedirs(user_data_parent)
        return profiles
        
    for item in os.listdir(user_data_parent):
        item_path = os.path.join(user_data_parent, item)
        if os.path.isdir(item_path):
            if (os.path.exists(os.path.join(item_path, 'Default')) or 
                any(p.startswith('Profile') for p in os.listdir(item_path) if os.path.isdir(os.path.join(item_path, p)))):
                profiles.append(item)
    return profiles

def select_profile(user_data_parent):
    """ì‚¬ìš©ìì—ê²Œ í”„ë¡œí•„ì„ ì„ íƒí•˜ë„ë¡ í•¨"""
    profiles = get_available_profiles(user_data_parent)
    if not profiles:
        print("\nì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.")
        create_new = input("ìƒˆ í”„ë¡œí•„ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
        if create_new == 'y':
            while True:
                name = input("ìƒˆ í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”: ")
                if not name:
                    print("í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                    continue
                    
                if any(c in r'\\/:*?"<>|' for c in name):
                    print("í”„ë¡œí•„ ì´ë¦„ì— ë‹¤ìŒ ë¬¸ìë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: \\ / : * ? \" < > |")
                    continue
                    
                new_profile_path = os.path.join(user_data_parent, name)
                if os.path.exists(new_profile_path):
                    print(f"'{name}' í”„ë¡œí•„ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")
                    continue
                    
                try:
                    os.makedirs(new_profile_path)
                    os.makedirs(os.path.join(new_profile_path, 'Default'))
                    print(f"'{name}' í”„ë¡œí•„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
                    return name
                except Exception as e:
                    print(f'í”„ë¡œí•„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}')
                    retry = input("ë‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
                    if retry != 'y':
                        return None
        return None
        
    print("\nì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œí•„ ëª©ë¡:")
    for idx, profile in enumerate(profiles, 1):
        print(f"{idx}. {profile}")
    print(f"{len(profiles) + 1}. ìƒˆ í”„ë¡œí•„ ìƒì„±")
        
    while True:
        try:
            choice = int(input("\nì‚¬ìš©í•  í”„ë¡œí•„ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”: "))
            if 1 <= choice <= len(profiles):
                selected_profile = profiles[choice - 1]
                print(f"\nì„ íƒëœ í”„ë¡œí•„: {selected_profile}")
                return selected_profile
            elif choice == len(profiles) + 1:
                # ìƒˆ í”„ë¡œí•„ ìƒì„±
                while True:
                    name = input("ìƒˆ í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”: ")
                    if not name:
                        print("í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                        continue
                        
                    if any(c in r'\\/:*?"<>|' for c in name):
                        print("í”„ë¡œí•„ ì´ë¦„ì— ë‹¤ìŒ ë¬¸ìë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: \\ / : * ? \" < > |")
                        continue
                        
                    new_profile_path = os.path.join(user_data_parent, name)
                    if os.path.exists(new_profile_path):
                        print(f"'{name}' í”„ë¡œí•„ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")
                        continue
                        
                    try:
                        os.makedirs(new_profile_path)
                        os.makedirs(os.path.join(new_profile_path, 'Default'))
                        print(f"'{name}' í”„ë¡œí•„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
                        return name
                    except Exception as e:
                        print(f'í”„ë¡œí•„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}')
                        retry = input("ë‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
                        if retry != 'y':
                            break
            else:
                print("ìœ íš¨í•˜ì§€ ì•Šì€ ë²ˆí˜¸ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.")
        except ValueError:
            print("ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

def main():
    # ì‚¬ìš©ì í”„ë¡œí•„ ê²½ë¡œ ì„¤ì •
    user_data_parent = r"C:\Users\ì‹ í˜„ë¹ˆ\Desktop\github\instaDM\user_data"
    
    # í”„ë¡œí•„ ì„ íƒ
    selected_profile = select_profile(user_data_parent)
    if not selected_profile:
        print("í”„ë¡œí•„ì„ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        return
        
    user_data_dir = os.path.join(user_data_parent, selected_profile)
    
    if not os.path.exists(user_data_dir):
        os.makedirs(user_data_dir)
        os.makedirs(os.path.join(user_data_dir, 'Default'))

    # Google Sheets API ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
    creds = get_credentials()
    service = build('sheets', 'v4', credentials=creds)

    # DM ëª©ë¡ ì‹œíŠ¸ ì„ íƒ
    selected_sheet = select_sheet(service, DM_LIST_SPREADSHEET_ID)
    if not selected_sheet:
        print("ì‹œíŠ¸ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        return

    # URLê³¼ ì´ë¦„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    url_name_pairs = get_data_from_sheets(service, selected_sheet)
    if not url_name_pairs:
        print("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        return

    # í…œí”Œë¦¿ ì‹œíŠ¸ ì„ íƒ
    print("\ní…œí”Œë¦¿ ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:")
    template_sheet = select_sheet(service, TEMPLATE_SPREADSHEET_ID)
    if not template_sheet:
        print("í…œí”Œë¦¿ ì‹œíŠ¸ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        return

    # ë©”ì‹œì§€ í…œí”Œë¦¿ ë§¤ë‹ˆì € ì´ˆê¸°í™”
    template_manager = InstagramMessageTemplate(TEMPLATE_SPREADSHEET_ID, template_sheet)
    
    # DM ë°œì†¡ ì „ í™•ì¸
    print(f"\nì„ íƒëœ ì„¤ì •:")
    print(f"â€¢ í”„ë¡œí•„: {selected_profile}")
    print(f"â€¢ DM ëª©ë¡ ì‹œíŠ¸: {selected_sheet}")
    print(f"â€¢ í…œí”Œë¦¿ ì‹œíŠ¸: {template_sheet}")
    print(f"â€¢ ë°œì†¡í•  DM ìˆ˜: {len(url_name_pairs)}ê°œ")
    
    if len(url_name_pairs) == 0:
        print("\në°œì†¡í•  DMì´ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        return
    
    # ë°œì†¡í•  ì¸í”Œë£¨ì–¸ì„œ ëª©ë¡ í‘œì‹œ
    print("\në°œì†¡í•  ì¸í”Œë£¨ì–¸ì„œ ëª©ë¡:")
    for idx, (url, name, notion_list, g_value, total_list) in enumerate(url_name_pairs, 1):
        print(f"{idx}. {name} ({g_value})")
    
    confirm = input("\nDMì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/N): ").upper()
    if confirm != 'Y':
        print("DM ë°œì†¡ì„ ì·¨ì†Œí•©ë‹ˆë‹¤.")
        return

    # Chrome ì˜µì…˜ ì„¤ì •
    options = Options()
    options.add_argument("--start-maximized")
    options.add_experimental_option("detach", True)
    options.add_argument("disable-blink-features=AutomationControlled")
    options.add_experimental_option("excludeSwitches", ["enable-logging"])
    options.add_argument(f"user-data-dir={user_data_dir}")
    options.add_argument("--disable-application-cache")
    options.add_argument("--disable-cache")

    # ìºì‹œì™€ ì„ì‹œ íŒŒì¼ ì •ë¦¬ (ë¡œê·¸ì¸ ì •ë³´ ìœ ì§€)
    clear_chrome_data(user_data_dir)

    # Chrome ë“œë¼ì´ë²„ ì´ˆê¸°í™”
    driver = webdriver.Chrome(options=options)
        
    print("\nDM ë°œì†¡ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
    
    # ê° URL ì²˜ë¦¬
    for index, (url, name, notion_list, g_value, total_list) in enumerate(url_name_pairs, start=2):
        print(f"\n[{index-1}/{len(url_name_pairs)}] {name} ({g_value})")
        process_url(driver, url, name, notion_list, g_value, total_list, template_manager, index, service, selected_sheet, user_data_dir)
        wait_time = random.uniform(5, 60)
        countdown(wait_time, "ë‹¤ìŒ URLë¡œ ì´ë™í•˜ê¸° ì „ ëŒ€ê¸°")

    # ë¸Œë¼ìš°ì € ì„¸ì…˜ ìœ ì§€
    driver.quit()

if __name__ == "__main__":
    main()
